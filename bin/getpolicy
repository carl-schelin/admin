#!/bin/bash

# import policy information from Openview into the Inventory
# first modify the chkpolicy.output to chkpolicy.input using temporary files
# then process the chkpolicy.input file to add any new entries to the policy_description and policy_type tables.
# then update or add the entry into the inventory for the server.

ADMIN=/usr/local/admin

for i in `grep -v "^#" $ADMIN/etc/servers | cut -f1 -d:`
do
  if [[ -f $ADMIN/servers/$i/chkpolicy.input ]]
  then
    rm $ADMIN/servers/$i/chkpolicy.input
  fi

# basically cleaning up the policy file. Some of the policies have spaces in the description so this is trying to make sure 
# we get clean input for the inventory
  if [[ -f $ADMIN/servers/$i/chkpolicy.output ]]
  then

    echo "Found: $i $ADMIN/servers/$i/chkpolicy.output"

    sed \
        -e "s/^  //g" \
        -e "s/                /:/g" \
        -e "s/               /:/g" \
        -e "s/              /:/g" \
        -e "s/             /:/g" \
        -e "s/            /:/g" \
        -e "s/           /:/g" \
        -e "s/          /:/g" \
        -e "s/         /:/g" \
        -e "s/        /:/g" \
        -e "s/       /:/g" \
        -e "s/      /:/g" \
        -e "s/     /:/g" \
        -e "s/    /:/g" \
        -e "s/   /:/g" \
        -e "s/  /:/g" \
        -e "s/ /_/g" \
        -e "s/\"//g" \
        $ADMIN/servers/$i/chkpolicy.output > $ADMIN/var/temp.policy

    if [[ -f $ADMIN/var/temp.policy ]]
    then
      grep -v "^$"                                                                                      $ADMIN/var/temp.policy > $ADMIN/var/tmp.policy
      grep -v "^:"                                                                                      $ADMIN/var/tmp.policy  > $ADMIN/var/temp.policy
      grep -v ":No_policies_are_installed_on_host_'localhost'."                                         $ADMIN/var/temp.policy > $ADMIN/var/tmp.policy
      grep -v ":*_List_installed_policies_for_host_'localhost'."                                        $ADMIN/var/tmp.policy  > $ADMIN/var/temp.policy
      grep -v "INFO::No_policies_are_installed_on_host_'localhost'."                                    $ADMIN/var/temp.policy > $ADMIN/var/tmp.policy
      grep -v "Package_HPOvConf_is_not_configured._Please_configure_the_package_before_using_ovpolicy." $ADMIN/var/tmp.policy  > $ADMIN/var/temp.policy
      grep -v ":Version"                                                                                $ADMIN/var/temp.policy > $ADMIN/var/tmp.policy
      grep -v "Type:Name::Status:Version"                                                               $ADMIN/var/tmp.policy  > $ADMIN/var/temp.policy
      grep -v "_--------------------------------------------------------------------"                   $ADMIN/var/temp.policy > $ADMIN/servers/$i/chkpolicy.input
    fi

    if [[ -s $ADMIN/servers/$i/chkpolicy.input ]]
    then
      /usr/local/bin/php /usr/local/httpd/bin/import.policy.php $i
    else
      rm $ADMIN/servers/$i/chkpolicy.input
    fi

    if [[ -f $ADMIN/var/temp.policy ]]
    then
      rm $ADMIN/var/temp.policy
    fi

    if [[ -f $ADMIN/var/tmp.policy ]]
    then
      rm $ADMIN/var/tmp.policy
    fi

  fi
done

